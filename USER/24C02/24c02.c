#include "24c02.h"  				 

/*********************************************************************************
*************************MCU040001÷ STM32F407020904020709・04°02******************************
**********************************************************************************
* 0202040601040604: 24C02.c                                                              *
* 0202040604ò0802050224C0205050904060004ò                                                        *
* 070705¨0609040305022015.03.09                                                           *
* °03    ±060502V1.0                                                                 *
* ×÷    09080502Clever                                                               *
* 0908    01÷0502IO070302050209IIC040206é070524c02090904070502×÷                                       * 
**********************************************************************************
*********************************************************************************/	

//IIC09080707IO07030802060108040304
void IIC_Init(void)
{			
  GPIO_InitTypeDef  GPIO_InitStructure;
  RCC_AHB1PeriphClockCmd(RCC_AHB1Periph_GPIOB, ENABLE);  //08010205GPIOB08±0007
  //GPIOB8,B906010804030407è0001
  GPIO_InitStructure.GPIO_Pin = GPIO_Pin_6 | GPIO_Pin_7;
  GPIO_InitStructure.GPIO_Mode = GPIO_Mode_OUT;          //040901¨0801060202050805
  GPIO_InitStructure.GPIO_OType = GPIO_OType_PP;         //010401ì08010602
  GPIO_InitStructure.GPIO_Speed = GPIO_Speed_50MHz;     //100MHz
  GPIO_InitStructure.GPIO_PuPd = GPIO_PuPd_UP;           //07030802
  GPIO_Init(GPIOB, &GPIO_InitStructure);                 //060108040304IO
	IIC_SCL=1;
	IIC_SDAOUT=1;
}
/*******************************************************************************
*************************060803000209IO070302050209IIC01¨0403**********************************
*******************************************************************************/
//IIC0408080404030203
void IIC_Start(void)
{
	SDA_OUT();     //03010001SDA0308020908010602
	IIC_SDAOUT=1;	  	  
	IIC_SCL=1;
	delay_us(4);
 	IIC_SDAOUT=0;
	delay_us(4);
	IIC_SCL=0;     //×04±00・04090103ò0507080908050606 
}	  
//IIC0105000104030203
void IIC_Stop(void)
{
	SDA_OUT();    //03010001SDA0308020908010602
	IIC_SCL=0;
	IIC_SDAOUT=0; 
 	delay_us(4);
	IIC_SCL=1; 
	IIC_SDAOUT=1; //・040901I2C×05030805á080304030203
	delay_us(4);							   	
}
/****************************************************************************
* 0104    0604: u8 MCU_Wait_Ack(void)
* 0107    02050502MCU08060705070707è±00070707080403020308050807
* 060507030502080505020207
* ・0803010502080505021:050708090707070808§°05  0:050708090707070806070107
* 0908    01÷0502  05B
****************************************************************************/
u8 MCU_Wait_Ack(void)
{
	u8 WaitTime=0;
	SDA_IN();      //03010001SDA0308020908010605  
	IIC_SDAOUT=1;
	delay_us(1);	   
	IIC_SCL=1;
	delay_us(1);	 
	while(IIC_SDAIN)
	{
		WaitTime++;
		if(WaitTime>250)
		{
			IIC_Stop();
			return 1;
		}
	}
	IIC_SCL=0; 
	return 0;  
}
/****************************************************************************
* 0104    0604: u8 void MCU_Send_Ack(void)
* 0107    02050502MCU05ú07úACK07070708,0003000924cxx
* 060507030502080505020207
* ・080301050208050502
* 0908    01÷0502  05B
****************************************************************************/
void MCU_Send_Ack(void)
{
	IIC_SCL=0;
	SDA_OUT();
	IIC_SDAOUT=0;
	delay_us(2);
	IIC_SCL=1;
	delay_us(2);
	IIC_SCL=0;
}
/****************************************************************************
* 0104    0604: u8 void MCU_Send_Ack(void)
* 0107    02050502MCU050305ú07úACK07070708	
* 060507030502080505020207
* ・080301050208050502
* 0908    01÷0502  05B
****************************************************************************/  
void MCU_NOAck(void)
{
	IIC_SCL=0;
	SDA_OUT();
	IIC_SDAOUT=1;
	delay_us(2);
	IIC_SCL=1;
	delay_us(2);
	IIC_SCL=0;
}	
/****************************************************************************
* 0104    0604: void IIC_write_OneByte(u8 Senddata)
* 0107    02050502IIC040706030002×0005030805EEPROM	
* 06050703050208050502Senddata:0407060508028020308050606
* ・080301050208050502
* 0908    01÷0502  05B
****************************************************************************/	  
void IIC_write_OneByte(u8 Senddata)
{                        
    u8 t;   
	  SDA_OUT(); 	    
    IIC_SCL=0;    //0802080108±0007070908040805060607000801
    for(t=0;t<8;t++)
    {              
        IIC_SDAOUT=(Senddata&0x80)>>7;
        Senddata<<=1; 	  
		delay_us(2);   
		IIC_SCL=1;
		delay_us(2); 
		IIC_SCL=0;	
		delay_us(2);
    }	 
} 
/****************************************************************************
* 0104    0604: void IIC_Read_OneByte(u8 Senddata)
* 0107    02050502IIC0909060306030002×000503
* 06050703050208050502ack=10501・040901ACK0501ack=00501・040901nACK 
* ・0803010502080505020909080508028020308050606
* 0908    01÷0502  05B
****************************************************************************/	  
u8 IIC_Read_OneByte(u8 ack)
{
	u8 i,receivedata=0;
	SDA_IN();       //03010001SDA0308020908010605  
    for(i=0;i<8;i++ )
	  {
        IIC_SCL=0; 
        delay_us(2);
		    IIC_SCL=1;
        receivedata<<=1;
        if(IIC_SDAIN)receivedata++;   
		delay_us(1); 
    }					 
    if (!ack)
        MCU_NOAck();//・040901nACK
    else
        MCU_Send_Ack(); //・040901ACK   
    return receivedata;
}
/*******************************IO070302050209IIC*************************************
*******************************************************************************/


/*******************************************************************************
*************************060803000209EEPROM24C02090904070502×÷******************************
*******************************************************************************/
//06010804030424c020802IIC05070703
void AT24C02_Init(void)
{
	IIC_Init();  //IIC060108040304
}
/****************************************************************************
* 0104    0604: u8 AT24C02_ReadByte(u8 ReadAddr)
* 0107    020505020803AT24C02000009¨080100・090906020603000208050606
* 06050703050208050502ReadAddr05020609090906030805060609ù08030802080100・
* ・0803010502080505020909080508028020308050606
* 0908    01÷0502  05B
****************************************************************************/
u8 AT24C02_ReadByte(u16 ReadAddr)
{				  
	u8 receivedata=0;		  	    																 
  
	IIC_Start();  
	IIC_write_OneByte(0XA0);           //・04090104÷0406080100・0XA0
	MCU_Wait_Ack();
  IIC_write_OneByte((uint8_t)(ReadAddr & 0x00FF));       //・0409010801080100・
	MCU_Wait_Ack();	    
	IIC_Start();  	 	   
	IIC_write_OneByte(0XA1);           //050306050507080902050805			   
	MCU_Wait_Ack();	 
  receivedata=IIC_Read_OneByte(0);		   
  IIC_Stop();                    //05ú07ú060300020105000100010406	    
	
	return receivedata;
}
/****************************************************************************
* 0104    0604: u8 AT24C02_WriteByte(u8 WriteAddr,u8 WriteData)
* 0107    020505020803AT24C02000009¨080100・040706050603000208050606
* 06050703050208050502WriteAddr05020609040706050805060609ù08030802080100・
            WriteData: 060904070605080208050606
* ・080301050208050502 
* 0908    01÷0502  05B
****************************************************************************/
void AT24C02_WriteByte(u16 WriteAddr,u8 WriteData)
{				   	  	    																 
  IIC_Start();  
	IIC_write_OneByte(0XA0);       //・0409010XA0,040708050606 	 
	MCU_Wait_Ack();	   
  IIC_write_OneByte((uint8_t)(WriteAddr & 0x00FF));  //・0409010801080100・
	MCU_Wait_Ack(); 	 										  		   
	IIC_write_OneByte(WriteData);  //・040901×000503							   
	MCU_Wait_Ack();  		    	   
  IIC_Stop();                    //05ú07ú060300020105000100010406 
	delay_ms(10);	 
}
/****************************************************************************
* 0104    0604: u8 AT24C02_Test(void)
* 0107    0205050205090808AT24C020805・0909050605
* 060507030502080505020207
* ・080301050208050502・0803011:04ì050908§°05
            ・0803010:04ì050906070107 
* 0908    01÷0502  05B
****************************************************************************/
u8 AT24C02_Test(void)
{
	u8 Testdata;
	Testdata=AT24C02_ReadByte(255); //06040104070903ú050908080501060507040008020704è0802070204070605	   
	if(Testdata==0XAB)return 0;		   
	else                             
	{
		AT24C02_WriteByte(255,0XAB);
	  Testdata=AT24C02_ReadByte(255);	  
		if(Testdata==0XAB)return 0;
	}
	return 1;											  
}
/****************************************************************************
* 0104    0604: u32 Buf_4Byte(u8 *pBuffer,u32 Date_4Byte,u8 Byte_num,u8 mode)
* 0107    0205050209à020308050705×0005030306×09
* 06050703050208050502mode05021:09à02030805×09・000607×000503   0:×0005030203050406070603000209à02030805
            Byte_num050204è0609×0903040802×0005030805
            *pBuffer0502×000503050708090805×é03ò×00050309ù08030805×é
            Date_4Byte050209à020308050805
* ・080301050208050502mode0209008±0501・08030109à02030805
* 0908    01÷0502Byte_num×0607ó020940002×0005030501000102040805080302ó010308020706010604090405090508±0703060304050905000809ù07010805
****************************************************************************/
u32 Buf_4Byte(u8 *pBuffer,u32 Date_4Byte,u8 Byte_num,u8 mode)
{
   u8 i; u32 middata=0;
	if(mode)    //09à02030805×09・000607×000503
	 {
	   for(i=0;i<Byte_num;i++)
	     {
	       *pBuffer++ =(Date_4Byte>>(8*i))&0xff;
	     }
			return 0; 
	 } 
	 else       //×0005030203050406070603000209à02030805
	 {
	    Date_4Byte=0;
		  pBuffer+=(Byte_num-1);
		  for(i=0;i<Byte_num;i++)
	      { 		
		      middata<<=8;
		      middata+= *pBuffer--;			   
	      }
			return middata;	
	 }
}
/****************************************************************************
* 0104    0604: void AT24C02_Read(u8 ReadAddr,u8 *pBuffer,u8 ReadNum)
* 0107    020505020707AT24C02080701030802000009¨080100・0709080409090602000009¨00020805080208050606
* 06050703050208050502ReadAddr :07090804090906020802080100・  0~255
            pBuffer  :080506060805×é08×080100・
            ReadNum:06090909060208050606080200020805
* ・080301050208050502
* 0908    01÷0502  05B
****************************************************************************/
void AT24C02_Read(u16 ReadAddr,u8 *pBuffer,u16 ReadNum)
{
	while(ReadNum--)
	{
		*pBuffer++=AT24C02_ReadByte(ReadAddr++);	
	}
} 
/****************************************************************************
* 0104    0604: void AT24C02_Write(u8 WriteAddr,u8 *pBuffer,u8 WriteNum)
* 0107    020505020707AT24C02080701030802000009¨080100・0709080404070605000009¨00020805080208050606
* 06050703050208050502WriteAddr :07090804040706050802080100・  0~255
            pBuffer  :080506060805×é08×080100・
            WriteNum:06090407060508050606080200020805
* ・080301050208050502
* 0908    01÷0502  05B
****************************************************************************/
void AT24C02_Write(u16 WriteAddr,u8 *pBuffer,u16 WriteNum)
{
	while(WriteNum--)
	{
		AT24C02_WriteByte(WriteAddr,*pBuffer);
		WriteAddr++;
		pBuffer++;
	}
}








